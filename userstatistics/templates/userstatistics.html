{% extends "site_base.html" %}

{% load i18n %}
{% block title %} {% trans "User Statistics" %} — {{ block.super }} {% endblock %}
{% block head %} {{ block.super }}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.3.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://rawgit.com/davidstutz/bootstrap-multiselect/master/dist/css/bootstrap-multiselect.css">
<!-- <script type="text/javascript" src="/static/lib/js/datauseractivity.js"></script> -->
<style>
#blockfilter .form-group {
  display: none;
}
/* reset */
.dropdown-menu>li>a {
  font-size: 14px;
  line-height: 1.42857143;
}
</style>
<script>
  var jsondata = {{ jsondata | safe }};
  var config = {};
  config['selectqry'] = [
    {
      text: 'User Raw Data',
      sql: 'SELECT * FROM user;',
      selected: true,
      nograph: true
    },
    {
      text: 'User Activity Raw Data',
      sql: 'SELECT * FROM usac;',
      selected: true,
      nograph: true
    },
    {
      text: 'Number of User Activity Group By Date and Resource',
      sql: 'SELECT * FROM (SELECT SUBSTRING(actiontime, 1, 10) AS `date`, resource, count(*) AS `count` FROM usac GROUP BY SUBSTRING(actiontime, 1, 10), resource) t1 ORDER BY `date`;',
      sqltemplate: 'SELECT * FROM (SELECT {datefunc} AS `date`, resource, count(*) AS `count` FROM usac {wherein} GROUP BY {datefunc}, resource) t1 ORDER BY `date`;',
      sqlfiltered: this.sql,
      filter: {},
      fnbuildsqlfiltered: function() {
        var arresource = $('#filterresource option:selected').map(function(a, b) {return '"'+b.value+'"';});
        var wherein = "WHERE `resource` IN ("+arresource.get().join()+')';
        var datefunc = 'SUBSTRING(actiontime, 1, 10)';
        if ($('#periodic').val() == 'weekly') {
          datefunc = 'isoWeekYear(actiontime)+\'-\'+MID(\'0\'+isoWeek(actiontime),-1)';
        }
        else if ($('#periodic').val() == 'monthly') {
          datefunc = 'YEAR(actiontime)+\'-\'+MID(\'0\'+MONTH(actiontime),-1)';
        }
        else if ($('#periodic').val() == 'quarterly') {
          datefunc = 'YEAR(actiontime)+\'-\'+parseInt((MONTH(actiontime)+2)/3)';
        }
        this.sqlfiltered = this.sqltemplate.format({wherein: wherein, datefunc: datefunc});
        this.filter['resource'] = $('#filterresource option:selected').map(function(a, b) {return b.value;}).get();
        return this.sqlfiltered;
      },
      fnsetfilters: function() {
        var queryopted = this;
        var arresource = alasql('SELECT resource, COUNT(*) AS `usercount` FROM usac GROUP BY resource ORDER BY COUNT(*) DESC, resource ASC;');
        fill_options($('#filterresource'), arresource, function(d) {return d['resource']}, function(d) {return d['resource']+' - '+d['usercount']+' user'});
        $('#filterresource').multiselect({
          maxHeight: 200,
          buttonWidth: '100%',
          includeSelectAllOption: true
        });
        // $('#filterresource').multiselect('select', arresource.slice(0, 3).map(function(r) {return r['resource']}));
        $('#filterresource').multiselect('selectAll', false);
        $('#filterresource').multiselect('updateButtonText');
        var showids = ['blockfilterresource', 'blockperiodic', 'blockbtnfiltersubmit'];
        $('#blockfilter .form-group').each(function() {
          if (showids.indexOf(this.id) === -1) {
            $(this).hide();
          }
          else {
            $(this).show();
          }
        });
      },
      fnfilldatatable: function(querydata) {
        filldatatable(querydata);
      },
      fngraph: function(data) {
        // convert alasql data to plotly format
        ylabels = [];
        xlabels = [];
        yvalues = {};
        plotlydata = [];
        xaxiscol = 'date';
        countcol = 'count';
        // ylabels = Object.keys(data[0]);
        qryopted = this;

        // find date count
        // r = alasql("SELECT COUNT(DISTINCT(SUBSTRING(actiontime, 1, 10))) AS `datecount` FROM usac;");
        // var datecount = r[0]['datecount'];

        // get all distinct resource to make y labels
        // r = alasql("SELECT resource, COUNT(resource) AS `number of user activity` FROM usac GROUP BY resource ORDER BY COUNT(resource) DESC;");

        var startdate = data[0]['date'];
        var enddate = data[data.length-1]['date'];
        xlabels = makeserialdates(startdate, enddate, $('#periodic').val());

        // limit displayed resources for performance reason
        var maxresources = 14;
        for (let i in this['filter']['resource'].slice(0, maxresources)) {
          var resourcename = this['filter']['resource'][i];
          ylabels.push(resourcename);
          yvalues[resourcename] = Array(xlabels.length).fill(0);
        }

        // add 'other' for the rest of resources
        if (this['filter']['resource'].length > maxresources) {
          ylabels.push('Other');
          yvalues['Other'] = Array(xlabels.length).fill(0);
        }

        // transfer data to yvalues
        for (let i in data) {
          createdate = data[i]['date'];
          resourcename = data[i]['resource'];
          createdateidx = xlabels.indexOf(createdate);
          if (createdateidx === -1) {
            // only put to x labels if element doesn't exist in array
            xlabels.push(createdate);
            createdateidx = xlabels.indexOf(createdate);
            yvalues[resourcename][createdateidx] = 0;
          }
          if (!ylabels.includes(resourcename)) resourcename = 'Other';
          yvalues[resourcename][createdateidx] += data[i]['count'];
        }

        // loop y labels to transfer data to chartdata
        var hichartseries = [];
        for (let i in ylabels.reverse()) {
          hichartseries.push({
            name: ylabels[i],
            data: yvalues[ylabels[i]],
          })
        }

        Highcharts.chart('graphuseractivity', {
          chart: {
            type: 'column',
            zoomType: 'x'
          },
          title: {
            text: '{periodic} Number of User Activity Group By Resource'.format({periodic: $("#periodic option:selected").text()})
          },
          xAxis: {
            categories: xlabels,
            type: 'date',
            dateTimeLabelFormats: {
              day: "%b %e, '%y",
              week: "%b %e, '%y"
            }
          },
          yAxis: {
            min: 0,
            title: {
              text: 'Number of User Activity Group By Resource'
            },
            stackLabels: {
              enabled: false,
              style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
              }
            }
          },
          tooltip: {
            // headerFormat: '<b>{point.x}</b><br/>',
            // pointFormat: '<span style="color:{series.color}">◼</span> {series.name}: <b>{point.y}</b><br/>',
            formatter: function () {
              // console.log('this', this);
              var s = '<b>' + this.x + '</b>';
              var t = 0, b = '';
              $.each(this.points, function () {
                if (this.y) {
                  b = '<br/><span style="color:'+this.color+'">◼</span> ' + this.series.name + ': <b>' +this.y + '</b>'+b;
                  t += this.y;
                }
              });
              s += b+'<br/><b>Total: '+t+'</>';
              return s;
            },
            // footerFormat: '<b>Total: {point.stackTotal}</b>',
            shared: true
          },
          plotOptions: {
            column: {
              stacking: 'normal'
            }
          },
          legend: {
            align: 'right',
            layout: 'vertical',
            verticalAlign: 'top',
            floating: false,
            width: 300,
            borderColor: 'None',
            itemMarginTop: 3,
            itemMarginBottom: 3,
            reversed: true,
            itemStyle: {
              color: '#000000',
              fontWeight: 'bold',
              lineHeight: '1.5em'
            }
          },
          series: hichartseries
        });
      }
    },
    {
      text: 'Number of User Activity Group By Date and Organization',
      sql: 'SELECT * FROM (SELECT SUBSTRING(`actiontime`, 1, 10) AS `date`, organization, count(*) AS `count` FROM usac GROUP BY SUBSTRING(`actiontime`, 1, 10), organization) t1 ORDER BY `date`;',
      sqltemplate: 'SELECT * FROM (SELECT {datefunc} AS `date`, organization, count(*) AS `count` FROM usac {wherein} GROUP BY {datefunc}, organization) t1 ORDER BY `date`;',
      sqlfiltered: this.sql,
      filter: {},
      fnbuildsqlfiltered: function() {
        var arorganization = $('#filterorganization option:selected').map(function(a, b) {return '"'+b.value+'"';});
        var wherein = "WHERE `organization` IN ("+arorganization.get().join()+')';
        var datefunc = 'SUBSTRING(actiontime, 1, 10)';
        if ($('#periodic').val() == 'weekly') {
          datefunc = 'isoWeekYear(actiontime)+\'-\'+MID(\'0\'+isoWeek(actiontime),-1)';
        }
        else if ($('#periodic').val() == 'monthly') {
          datefunc = 'YEAR(actiontime)+\'-\'+MID(\'0\'+MONTH(actiontime),-1)';
        }
        else if ($('#periodic').val() == 'quarterly') {
          datefunc = 'YEAR(actiontime)+\'-\'+parseInt((MONTH(actiontime)+2)/3)';
        }
        this.sqlfiltered = this.sqltemplate.format({wherein: wherein, datefunc: datefunc});
        this.filter['organization'] = $('#filterorganization option:selected').map(function(a, b) {return b.value;}).get();
        return this.sqlfiltered;
      },
      fnsetfilters: function() {
        var queryopted = this;
        var arorganization = alasql('SELECT organization, COUNT(*) AS `usercount` FROM user GROUP BY organization ORDER BY COUNT(*) DESC, organization ASC;');
        fill_options($('#filterorganization'), arorganization, function(d) {return d['organization']}, function(d) {return d['organization']+' - '+d['usercount']+' activity'});
        $('#filterorganization').multiselect({
          maxHeight: 200,
          buttonWidth: '100%',
          includeSelectAllOption: true
        });
        // $('#filterorganization').multiselect('select', arorganization.slice(0, 3).map(function(r) {return r['organization']}));
        $('#filterorganization').multiselect('selectAll', false);
        $('#filterorganization').multiselect('updateButtonText');
        var showids = ['blockfilterorganization', 'blockperiodic', 'blockbtnfiltersubmit'];
        $('#blockfilter .form-group').each(function() {
          if (showids.indexOf(this.id) === -1) {
            $(this).hide();
          }
          else {
            $(this).show();
          }
        });
      },
      fnfilldatatable: function(querydata) {
        filldatatable(querydata);
      },
      fngraph: function(data) {
        // convert alasql data to plotly format
        ylabels = [];
        xlabels = [];
        yvalues = {};
        plotlydata = [];
        xaxiscol = 'date';
        countcol = 'count';
        // ylabels = Object.keys(data[0]);
        qryopted = this;

        // find date count
        // r = alasql("SELECT COUNT(DISTINCT(SUBSTRING(actiontime, 1, 10))) AS `datecount` FROM usac;");
        // var datecount = r[0]['datecount'];

        // get all distinct organization to make y labels
        // r = alasql("SELECT organization, COUNT(organization) AS `number of user activity` FROM usac GROUP BY organization ORDER BY COUNT(organization) DESC;");

        var startdate = data[0]['date'];
        var enddate = data[data.length-1]['date'];
        xlabels = makeserialdates(startdate, enddate, $('#periodic').val());

        // limit displayed resources for performance reason
        var maxresources = 14;
        for (let i in this['filter']['organization'].slice(0, maxresources)) {
          var resourcename = this['filter']['organization'][i];
          ylabels.push(resourcename);
          yvalues[resourcename] = Array(xlabels.length).fill(0);
        }

        // add 'other' for the rest of resources
        if (this['filter']['organization'].length > maxresources) {
          ylabels.push('Other');
          yvalues['Other'] = Array(xlabels.length).fill(0);
        }

        // transfer data to yvalues
        for (let i in data) {
          createdate = data[i]['date'];
          resourcename = data[i]['organization'];
          createdateidx = xlabels.indexOf(createdate);
          if (createdateidx === -1) {
            // only put to x labels if element doesn't exist in array
            xlabels.push(createdate);
            createdateidx = xlabels.indexOf(createdate);
            yvalues[resourcename][createdateidx] = 0;
          }
          if (!ylabels.includes(resourcename)) resourcename = 'Other';
          yvalues[resourcename][createdateidx] += data[i]['count'];
        }

        // loop y labels to transfer data to chartdata
        var hichartseries = [];
        for (let i in ylabels.reverse()) {
          hichartseries.push({
            name: ylabels[i],
            data: yvalues[ylabels[i]],
          })
        }

        Highcharts.chart('graphuseractivity', {
          chart: {
            type: 'column',
            zoomType: 'x'
          },
          title: {
            text: '{periodic} Number of User Activity Group By Organization'.format({periodic: $("#periodic option:selected").text()})
          },
          xAxis: {
            categories: xlabels,
            type: 'date',
            dateTimeLabelFormats: {
              day: "%b %e, '%y",
              week: "%b %e, '%y"
            }
          },
          yAxis: {
            min: 0,
            title: {
              text: 'Number of User Activity Group By Organization'
            },
            stackLabels: {
              enabled: false,
              style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
              }
            }
          },
          tooltip: {
            // headerFormat: '<b>{point.x}</b><br/>',
            // pointFormat: '<span style="color:{series.color}">◼</span> {series.name}: <b>{point.y}</b><br/>',
            formatter: function () {
              // console.log('this', this);
              var s = '<b>' + this.x + '</b>';
              var t = 0, b = '';
              $.each(this.points, function () {
                if (this.y) {
                  b = '<br/><span style="color:'+this.color+'">◼</span> ' + this.series.name + ': <b>' +this.y + '</b>'+b;
                  t += this.y;
                }
              });
              s += b+'<br/><b>Total: '+t+'</>';
              return s;
            },
            // footerFormat: '<b>Total: {point.stackTotal}</b>',
            shared: true
          },
          plotOptions: {
            column: {
              stacking: 'normal'
            }
          },
          legend: {
            align: 'right',
            layout: 'vertical',
            verticalAlign: 'top',
            floating: false,
            // width: 300,
            borderColor: 'None',
            itemMarginTop: 3,
            itemMarginBottom: 3,
            // reversed: true,
            // y: 15,
            itemStyle: {
              color: '#000000',
              fontWeight: 'bold',
              lineHeight: '1.5em'
            }
          },
          series: hichartseries
        });
      }
    },
    {
      text: 'User Growth Group By Organization',
      sql: 'SELECT * FROM user;',
      disabled: false,
      nograph: false,
      sqltemplate: 'SELECT * FROM (SELECT {datefunc} AS `date`, organization, count(*) AS `count` FROM user {wherein} GROUP BY {datefunc}, organization) t1 ORDER BY `date`;',
      sqlfiltered: this.sql,
      filter: {},
      fnbuildsqlfiltered: function() {
        var arorganization = $('#filterorganization option:selected').map(function(a, b) {return '"'+b.value+'"';});
        var wherein = "WHERE `organization` IN ("+arorganization.get().join()+')';
        var datefunc = 'SUBSTRING(date_join, 1, 10)';
        if ($('#periodic').val() == 'weekly') {
          datefunc = 'isoWeekYear(date_join)+\'-\'+MID(\'0\'+isoWeek(date_join),-1)';
        }
        else if ($('#periodic').val() == 'monthly') {
          datefunc = 'YEAR(date_join)+\'-\'+MID(\'0\'+MONTH(date_join),-1)';
        }
        else if ($('#periodic').val() == 'quarterly') {
          datefunc = 'YEAR(date_join)+\'-\'+parseInt((MONTH(date_join)+2)/3)';
        }
        this.sqlfiltered = this.sqltemplate.format({wherein: wherein, datefunc: datefunc});
        this.filter['organization'] = $('#filterorganization option:selected').map(function(a, b) {return b.value;}).get();
        return this.sqlfiltered;
      },
      fnsetfilters: function() {
        var queryopted = this;
        var arorganization = alasql('SELECT organization, COUNT(*) AS `usercount` FROM user GROUP BY organization ORDER BY COUNT(*) DESC;');
        fill_options($('#filterorganization'), arorganization, function(d) {return d['organization']}, function(d) {return d['organization']+' - '+d['usercount']+' user'});
        $('#filterorganization').multiselect({
          maxHeight: 200,
          buttonWidth: '100%',
          includeSelectAllOption: true
        });
        // $('#filterorganization').multiselect('select', arorganization.slice(0, 3).map(function(r) {return r['organization']}));
        $('#filterorganization').multiselect('selectAll', false);
        $('#filterorganization').multiselect('updateButtonText');
        var showids = ['blockfilterorganization', 'blockperiodic', 'blockbtnfiltersubmit'];
        $('#blockfilter .form-group').each(function() {
          if (showids.indexOf(this.id) === -1) {
            $(this).hide();
          }
          else {
            $(this).show();
          }
        });
      },
      fngraph: function(data) {
        // convert alasql data to plotly format
        ylabels = [];
        xlabels = [];
        yvalues = {};
        plotlydata = [];
        xaxiscol = 'date';
        countcol = 'count';
        // ylabels = Object.keys(data[0]);
        qryopted = this;

        // find date count
        // userbyorg = alasql("SELECT `organization`, COUNT(*) AS `count` FROM user GROUP BY `organization` ORDER BY `count` DESC;");
        // var datecount = r[0]['datecount'];

        // get all distinct organization to make y labels
        // r = alasql("SELECT organization, COUNT(organization) AS `number of user activity` FROM usac GROUP BY organization ORDER BY COUNT(organization) DESC;");

        var startdate = data[0]['date'];
        var enddate = data[data.length-1]['date'];
        xlabels = makeserialdates(startdate, enddate, $('#periodic').val());

        // limit displayed resources for performance reason
        var maxresources = 14;
        for (let i in this['filter']['organization'].slice(0, maxresources)) {
          var resourcename = this['filter']['organization'][i];
          ylabels.push(resourcename);
          yvalues[resourcename] = Array(xlabels.length).fill(0);
        }

        // add 'other' for the rest of resources
        if (this['filter']['organization'].length > maxresources) {
          ylabels.push('Other');
          yvalues['Other'] = Array(xlabels.length).fill(0);
        }

        // transfer data to yvalues
        for (let i in data) {
          createdate = data[i]['date'];
          resourcename = data[i]['organization'];
          createdateidx = xlabels.indexOf(createdate);
          if (createdateidx === -1) {
            // only put to x labels if element doesn't exist in array
            xlabels.push(createdate);
            createdateidx = xlabels.indexOf(createdate);
            yvalues[resourcename][createdateidx] = 0;
          }
          if (!ylabels.includes(resourcename)) resourcename = 'Other';
          yvalues[resourcename][createdateidx] += data[i]['count'];
        }

        // accumulated total
        for (let i in ylabels) {
          for (var i2 = 0; i2 < yvalues[ylabels[i]].length-1; i2++) {
            yvalues[ylabels[i]][i2+1] += yvalues[ylabels[i]][i2];
          }
        }

        // loop y labels to transfer data to chartdata
        var hichartseries = [];
        for (let i in ylabels.reverse()) {
          hichartseries.push({
            name: ylabels[i],
            data: yvalues[ylabels[i]],
          })
        }

        Highcharts.chart('graphuseractivity', {
          chart: {
            type: 'column',
            zoomType: 'x'
          },
          title: {
            text: '{periodic} User Growth Group By Organization'.format({periodic: $("#periodic option:selected").text()}),
          },
          xAxis: {
            categories: xlabels,
            type: 'date',
            dateTimeLabelFormats: {
              day: "%b %e, '%y",
              week: "%b %e, '%y"
            }
          },
          yAxis: {
            min: 0,
            title: {
              text: 'Number of User'
            },
            stackLabels: {
              enabled: false,
              style: {
                fontWeight: 'bold',
                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
              }
            }
          },
          tooltip: {
            // headerFormat: '<b>{point.x}</b><br/>',
            // pointFormat: '<span style="color:{series.color}">◼</span> {series.name}: <b>{point.y}</b><br/>',
            formatter: function () {
              // console.log('this', this);
              var s = '<b>' + this.x + '</b>';
              var t = 0, b = '';
              $.each(this.points, function () {
                if (this.y) {
                  b = '<br/><span style="color:'+this.color+'">◼</span> ' + this.series.name + ': <b>' +this.y + '</b>'+b;
                  t += this.y;
                }
              });
              s += b+'<br/><b>Total: '+t+'</>';
              return s;
            },
            // footerFormat: '<b>Total: {point.stackTotal}</b>',
            shared: true
          },
          plotOptions: {
            column: {
              stacking: 'normal'
            }
          },
          legend: {
            align: 'right',
            layout: 'vertical',
            verticalAlign: 'top',
            floating: false,
            // width: auto,
            borderColor: 'None',
            itemMarginTop: 3,
            itemMarginBottom: 3,
            // reversed: true,
            // y: 15,
            itemStyle: {
              color: '#000000',
              fontWeight: 'bold',
              lineHeight: '1.5em'
            }
          },
          series: hichartseries
        });
      },
      fngraph2: function(data) {
        // convert alasql data to chart format

        ylabels = [];
        xlabels = [];
        yvalues = {};
        plotlydata = [];
        xaxiscol = 'date';
        countcol = 'count';
        // ylabels = Object.keys(data[0]);

        // build xlabels
        r = alasql("SELECT * FROM (SELECT SUBSTRING(date_join, 1, 10) AS `date_join`, COUNT(SUBSTRING(date_join, 1, 10)) AS `newusercount` FROM user GROUP BY SUBSTRING(date_join, 1, 10)) t1 ORDER BY date_join;");
        var startdate = r[0]['date_join'];
        var enddate = r[r.length-1]['date_join'];
        xlabels = makeserialdates(startdate, enddate);

        // transfer 'newusercount' values to yvalues
        var idate;
        ylabels.push('total user');
        yvalues[ylabels[0]] = Array(xlabels.length).fill(0);
        for (let i in r) {
          idate = xlabels.indexOf(r[i]['date_join']);
          yvalues[ylabels[0]][idate] = r[i]['newusercount'];
        }
        // console.log('yvalues', yvalues);

        // replace yvalues values into running total
        var runningtotal = 0;
        for (let i in yvalues[ylabels[0]]) {
          runningtotal += yvalues[ylabels[0]][i];
          yvalues[ylabels[0]][i] = runningtotal;
        }

        // loop y labels to transfer data to chart data
        var hichartseries = [];
        for (let i in ylabels.reverse()) {
          hichartseries.push({
            name: ylabels[i],
            data: yvalues[ylabels[i]],
          })
        }

        Highcharts.chart('graphuseractivity', {
          chart: {
            // type: 'column',
            zoomType: 'x'
          },
          title: {
            text: 'User Growth Chart'
          },
          xAxis: {
            categories: xlabels,
            type: 'date',
            dateTimeLabelFormats: {
              day: "%b %e, '%y",
              week: "%b %e, '%y"
            }
          },
          // yAxis: {
          //   min: 0,
          //   title: {
          //     // text: 'Number of User Activity Group By Resource'
          //   },
          //   stackLabels: {
          //     enabled: false,
          //     style: {
          //       fontWeight: 'bold',
          //       color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
          //     }
          //   }
          // },
          // tooltip: {['user growth']
          //   headerFormat: '<b>{point.x}</b><br/>',
          //   pointFormat: '<span style="color:{series.color}">◼</span> {series.name}: <b>{point.y}</b><br/>',
          //   // footerFormat: '<b>Total: {point.stackTotal}</b>',
          //   shared: true
          // },
          // plotOptions: {
          //   column: {
          //     stacking: 'normal'
          //   }
          // },
          legend: {
            align: 'right',
            layout: 'vertical',
            verticalAlign: 'top',
            floating: false,
            borderColor: 'None',
            itemMarginTop: 3,
            itemMarginBottom: 3,
            y: 15,
            itemStyle: {
              color: '#000000',
              fontWeight: 'bold',
              lineHeight: '1.5em'
            }
          },
          series: hichartseries
        });

      }
    }
  ];
  function makeserialdates(startdate, enddate, periodic) {
    periodic = periodic || 'daily';
    var arrdates = [];
    var year, quarter, month, week, day, strdate;
    if (periodic == 'weekly') {
      var startdateobj = moment().isoWeekYear(startdate.substr(0, 4)).isoWeek(startdate.substr(5, 2)).toDate();
      var enddateobj = moment().isoWeekYear(enddate.substr(0, 4)).isoWeek(enddate.substr(5, 2)).toDate();
      var endtimestamp = enddateobj.valueOf();
      strdate = startdate;
      for (var d = startdateobj; strdate < enddate; d.setDate(d.getDate() + 7)) {
        year = moment(d).isoWeekYear();
        // month = ('0'+(d.getMonth()+1)).substr(-2);
        week = ('0'+(moment(d).isoWeek())).substr(-2);
        strdate = year+'-'+week;
        arrdates.push(strdate);
      }
    }
    else if (periodic == 'monthly') {
      var startdateobj = new Date(startdate+'-01');
      var enddateobj = new Date(enddate+'-01');
      var endtimestamp = enddateobj.valueOf();
      for (var d = startdateobj; d.valueOf() <= endtimestamp; d.setMonth(d.getMonth() + 1)) {
        year = d.getFullYear();
        month = ('0'+(d.getMonth()+1)).substr(-2);
        strdate = year+'-'+month;
        arrdates.push(strdate);
      }
    }
    else if (periodic == 'quarterly') {
      var startdateobj = new Date(startdate.substr(0, 4), parseInt(startdate.substr(5, 1)*3-3));
      var enddateobj = new Date(enddate.substr(0, 4), parseInt(enddate.substr(5, 1)*3-3));
      var endtimestamp = enddateobj.valueOf();
      for (var d = startdateobj; d.valueOf() <= endtimestamp; d.setMonth(d.getMonth() + 3)) {
        year = d.getFullYear();
        month = ('0'+(d.getMonth()+1)).substr(-2);
        quarter = parseInt((d.getMonth()+3)/3);
        strdate = year+'-'+quarter;
        arrdates.push(strdate);
      }
    }
    else {
      var startdateobj = new Date(startdate);
      var enddateobj = new Date(enddate);
      var endtimestamp = enddateobj.valueOf();
      for (var d = new Date(startdate); d.valueOf() <= endtimestamp; d.setDate(d.getDate() + 1)) {
        year = d.getFullYear();
        month = ('0'+(d.getMonth()+1)).substr(-2);
        day = ('0'+(d.getDate())).substr(-2);
        strdate = year+'-'+month+'-'+day;
        arrdates.push(strdate);
      }
    }
    return arrdates;
  }
</script>
<style>
  #tbluseractivity th {
    text-transform: capitalize;
  }
  /* hide for now, TODO: filterorganizationoption functionality */
  #filterorganizationoption {
    display: none;
  }
  /* hide for now, TODO: filterresourceoption functionality */
  #filterresourceoption {
    display: none;
  }
  /* hide for now, TODO: tblgraphdetail functionality */
  #tblgraphdetail {
    display: none;
  }
</style>
{% endblock %}

{% block header %}
<div class="se-pre-con">
  <span class=""><i id="spinner" class="fa fa-spinner fa-spin fa-1x fa-fw" style=""></i>&nbsp;Loading ...</span>
</div>
<style>
/* Paste this css to your style sheet file or under head tag */
/* This only works with JavaScript,
if it's not present, don't show loader */
.no-js #loader { display: none;  }
.js #loader { display: block; position: absolute; left: 100px; top: 0; }
.se-pre-con {
  position: fixed;
  left: 0px;
  top: 0px;
  width: 100%;
  height: 100%;
  z-index: 9999;
  background: url(./static/lib/img/Preloader_2.gif) center no-repeat #fff;
}
.se-pre-con.noimg{
  background-image: none;
  background-color: rgba(255, 255, 255, 0.5);
}
.se-pre-con.noimg span{
  top: 50%;
}
.se-pre-con i#spinner{
  display: none;
}
.se-pre-con.noimg i#spinner{
  display: inline-block;;
}
.se-pre-con span{
  position: fixed;
  left: 0px;
  top: 62%;
  width: 100%;
  height: 100%;
  z-index: 99999;
  text-align: center;
  font-size: 26pt;
}
/*.bg-opaque {
  background-color: rgba(255, 255, 255, 0.5);
}*/
</style>
{{ block.super }}
{% endblock %}

{% block body_outer %}
<div class="page-header">
  <h2>{% trans "User Statistics" %}</h2>
</div>

<div class="row">
  <div class="col-md-12">
    <p class="lead">{% trans "Query" %}</p>
    <form class="">
      <!-- <div class="form-group">
        <label for="selectsql" class="col-sm-2 control-label">Select Query</label>
        <div class="col-sm-3">
          <select id="selectsql" class="form-control">
            <option selected="selected">Raw Data</option>
            <option>Group By Resource</option>
          </select>
        </div>
      </div> -->
      <div class="form-group">
        <label for="selectsql">Select Query</label>
        <select id="selectsql" class="form-control">
          <option selected="selected"></option>
        </select>
      </div>
    </form>
  </div>
  <div id="blockfilter" class="col-md-12">
    <p class="lead">{% trans "Filter" %}</p>
    <form class="">
      <div id="blockfilterresource" class="form-group">
        <label for="filterresource">Filter Resource</label>
        <select id="filterresource" class="form-control" multiple="multiple">
        </select>
        <span id="filterorganizationoption"><span id="setsort">Sort by: <a id="sortbyname">Name</a>, <a id="sortbynumber">Number of User</a></span>, <span id="setselect">Select: <a id="selectall">All</a>, <a id="selectnone">None</a></span></span>
      </div>
      <div id="blockfilterorganization" class="form-group">
        <label for="filterorganization">Filter Organization</label>
        <select id="filterorganization" class="form-control" multiple="multiple">
        </select>
        <p id="filterorganizationoption"><span id="setsort">Sort by: <a id="sortbyname">Name</a>, <a id="sortbynumber">Number of User</a></span>, <span id="setselect">Select: <a id="selectall">All</a>, <a id="selectnone">None</a></span></p>
      </div>
      <div id="blockperiodic" class="form-group">
        <label for="periodic">Periodic</label>
        <select id="periodic" class="form-control">
          <option selected="selected" value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </div>
      <div id="blockbtnfiltersubmit" class="form-group">
        <button id="btnfiltersubmit" class="btn btn-primary" type="button">Filter</button>
      </div>
    </form>
  </div>
  <div class="col-md-12">
    <p class="lead">{% trans "Chart" %}</p>
    <!-- <div id="graphuseractivity" style="min-width: 310px; max-width: 800px; height: 400px; margin: 0 auto"></div> -->
    <div id="graphuseractivity"></div>
    <!-- <canvas id="canvasuseractivity" width="100%" height="482" style="display: block; width: 100%; height: 482px;"></canvas> -->
    <!-- <table id="tblgraphdetail" class="stripe row-border order-column" role="grid" aria-describedby="" style=""> -->
  </div>
  <div class="col-md-12">
    <p class="lead">{% trans "Table" %}</p>
    <table id="tbluseractivity" class="stripe row-border order-column" role="grid" aria-describedby="" style="">
    </table>
  </div>
  <!-- <div class="col-md-4">
</div> -->
</div>
{% endblock %}
{% block extra_script %}
{{ block.super }}
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js" integrity="sha256-SiHXR50l06UwJvHhFY4e5vzwq75vEHH+8fFNpkXePr0=" crossorigin="anonymous"></script> -->
<!-- <script type="text/javascript" src="http://kripken.github.io/sql.js/js/sql.js"></script> -->
<script type="text/javascript" src="http://cdn.jsdelivr.net/alasql/0.3/alasql.min.js"></script> <!-- v0.3.9 -->
<script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- v1.28.3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script> <!-- v5.0.12 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/5.0.12/js/themes/grid-light.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://rawgit.com/davidstutz/bootstrap-multiselect/master/dist/js/bootstrap-multiselect.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.print.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.flash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.27/build/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.print.min.js"></script>
<script type="text/javascript">

var dtoptionsbase = {
  // data: jsondata['useractivities']['data'],
  // columns: dtcolumns,
  autoWidth: false,
  dom: 'Bfrtip',
  buttons: [
    {
      extend: "copy",
      className: "btn-sm"
    },
    {
      extend: "csv",
      className: "btn-sm"
    },
    {
      extend: "excel",
      className: "btn-sm"
    },
    {
      extend: "print",
      className: "btn-sm"
    },
    // {
    //   extend: "colvis"
    //   className: "btn-sm"
    // }
  ],
  // responsive: true,

  "columnDefs": [{
    // "type": "num",
    // "visible": false,
    // "render": function (data, type, row){
      // if (type == 'display') {return humanizeFormatter(data);}
      // return data;
    // },
    // console.log(data, type, row);
    // return data+'K';
    // },
    // "targets": [1, 2, 3, 4, 5, 6, 7, 8, 9]
  }]
}

// string format function
// usage: "{greeting} {who}!".format({greeting: "Hello", who: "world"})
String.prototype.format = function(placeholders) {
    var s = this;
    for(var propertyName in placeholders) {
        var re = new RegExp('{' + propertyName + '}', 'gm');
        s = s.replace(re, placeholders[propertyName]);
    }
    return s;
};

function fill_options(elm, data, fnvalue, fntext) {
  var optvalue, opttext;
  elm.empty();
  for (let i in data){
    selected = data[i]['selected'] ? ' selected="selected"' : '';
    if (data[i]['disabled'] !== true) {
      optvalue = fnvalue ? fnvalue(data[i]) : i;
      opttext = fntext ? fntext(data[i]) : data[i]['text'];
      elm.append('<option value="'+optvalue+'" '+selected+'>' + opttext +'</option>');
    }
  }
  return false;
}

// draw chart and datatable
function renderoutput(queryopted) {

  // start load anim
  $(".se-pre-con").css('display', 'initial');

  // wrap long process in async function call
  setTimeout(function() {
    var strsql = queryopted.sqlfiltered || queryopted.sql;
    var arvalues = alasql(strsql);
    // console.log(strsql);

    // remove previous chart
    if ($("#graphuseractivity").highcharts()) {
      $("#graphuseractivity").highcharts().destroy()
    }

    // draw graph
    if (!queryopted['nograph'] && (queryopted['fngraph'])) {
      queryopted['fngraph'](arvalues);
    }

    // render datatable
    if (queryopted['fnfilldatatable']) {
      queryopted['fnfilldatatable'](arvalues);
    }
    else {
      filldatatable(arvalues);
    }

    // stop load anim
    $(".se-pre-con").fadeOut("slow");
  }, 0);
}

// common function for fnfilldatatable
function filldatatable(querydata) {

    // convert array to datatable columns
    function makedtcolumns(arcolumns) {
      var dtcolumns = [];
      for (let i in arcolumns) {
        dtcolumns.push({title: arcolumns[i], data: arcolumns[i]});
      }
      return dtcolumns;
    }

    // reinitialize datatable
    var dtoptions = Object.assign({}, dtoptionsbase); // clone dtoptionsbase
    dtoptions['data'] = querydata;
    dtoptions['columns'] = makedtcolumns(Object.keys(querydata[0]));
    var tblusac = $('#tbluseractivity');
    if ($.fn.DataTable.isDataTable('#tbluseractivity')) {
      // destroy previous datatable instance
      tblusac.dataTable().api().destroy();
      tblusac.empty(); // empty in case the columns change
    }
    tblusac.DataTable(dtoptions);
}

// wrapper to run function asyncronously
function runasync(func) {

    // start load anim
    $(".se-pre-con").css('display', 'initial');

    // use setTimeout to make async function call
    setTimeout(function() {

      // call main function
      func();

      // stop load anim
      $(".se-pre-con").fadeOut("slow");
    }, 0);
}

window.onload = function() {
  // console.log("window.onload");

  // add alasql user defined function
  alasql.fn.parseInt = function(x) { return parseInt(x); }
  alasql.fn.isoWeek = function(d) { return moment(d).isoWeek(); }
  alasql.fn.isoWeekYear = function(d) { return moment(d).isoWeekYear(); }

  // Animate loader off screen
  $(".se-pre-con").fadeOut("slow");

  // change loader animation
  $(".se-pre-con").addClass("noimg")

  var t0, t1;
  // var dtcolumns = [];
  // for (let i in jsondata['useractivities']['columns']) {
  //   dtcolumns.push({title: jsondata['useractivities']['columns'][i]});
  // }

  fill_options($('#selectsql'), config['selectqry']);

  // on change, requery datatable source data
  $('#selectsql').change(function(event) {
    var selectedval = this.options[this.selectedIndex].value;
    var queryopted = config['selectqry'][selectedval];

    // hide filters
    $('#blockfilter .form-group').each(function() {
      $(this).hide();
    });

    // clear previous output
    runasync(function() {

      // remove previous chart
      if ($("#graphuseractivity").highcharts()) {
        $("#graphuseractivity").highcharts().destroy()
      }

      // remove previous datatable
      var tblusac = $('#tbluseractivity');
      if ($.fn.DataTable.isDataTable('#tbluseractivity')) {
        // destroy previous datatable instance
        tblusac.dataTable().api().destroy();
        tblusac.empty(); // empty in case the columns change
      }

      // set filters or render output
      if (queryopted.fnsetfilters) {
        queryopted.fnsetfilters();
      }
      else {
        renderoutput(queryopted);
      }
    });

  });


  // console.log('dtcolumns', dtcolumns);
  // console.log("DataTable init time start.");
  // t0 = performance.now();
  // $('#tbluseractivity').DataTable(dtoptions);
  // t1 = performance.now();
  // console.log("DataTable init time end: " + (t1 - t0) + " milliseconds.");

  // db = new SQL.Database();
  // var tblua = 'useractivities';
  // db.run("CREATE TABLE "+tblua+' ('+jsondata['useractivities']['columns'].join(', ')+');');
  // sqlinsert = [];
  // console.log("sqlite insert time start.");
  // t0 = performance.now();
  // for (let i in jsondata['useractivities']['data']) {
  //   // db.run("INSERT INTO useractivities VALUES (?,?,?,?);", [jsondata['useractivities']['data'][0], jsondata['useractivities']['data'][1], jsondata['useractivities']['data'][2], jsondata['useractivities']['data'][3]]);
  //   db.run("INSERT INTO useractivities VALUES (?,?,?,?);", jsondata['useractivities']['data'][i]);
  //   if (i%1000==0) {console.log('i',i);}
  //   // sqlinsert.push("INSERT INTO useractivities VALUES (\'"+jsondata['useractivities']['data'][i][0]+'\',\''+jsondata['useractivities']['data'][i][1]+'\',\''+jsondata['useractivities']['data'][i][2]+'\',\''+jsondata['useractivities']['data'][i][3]+'\');');
  // }
  // // db.run(sqlinsert.join());
  // t1 = performance.now();
  // console.log("sqlite insert time end: " + (t1 - t0) + " milliseconds.");
  // res = db.exec("SELECT * FROM useractivities;");

  function array2alasql(arraydata) {
    // convert arraydata to alasql data
    alasqldata = [];
    for (let i in arraydata['data']) {
      alasqldata[i] = [];
      a = {};
      for (let i2 in arraydata['columns']) {
        a[arraydata['columns'][i2]] = arraydata['data'][i][i2];
      }
      alasqldata[i] = a;
    }
    return alasqldata;
  }

  alasql("CREATE TABLE usac ("+jsondata['useractivities']['columns'].join(', ')+')');
  alasql.tables.usac.data = array2alasql(jsondata['useractivities']);

  alasql("CREATE TABLE user ("+jsondata['user']['columns'].join(', ')+')');
  alasql.tables.user.data = array2alasql(jsondata['user']);

  // for first run, trigger event handler to initialize datatable
  $('#selectsql').trigger({
    type: 'change',
    firstrun: true
  });

  $('#btnfiltersubmit').on('click', function(event) {
    var qryidx = $('#selectsql').val();
    var queryopted = config['selectqry'][qryidx];
    if (queryopted.fnbuildsqlfiltered) {
      queryopted.fnbuildsqlfiltered();
    }
    renderoutput(queryopted);
  });

};

</script>
{% endblock extra_script %}
